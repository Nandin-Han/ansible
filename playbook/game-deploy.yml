---
- name: éƒ¨ç½²æ¸¸æˆæœåŠ¡å™¨
  hosts: gameservers
  become: true
  gather_facts: true

  vars:
    # å¿…éœ€çš„è¿è¡Œæ—¶å˜é‡ï¼ˆé€šè¿‡ -e å‚æ•°ä¼ å…¥ï¼‰
    # game_name: "tongits"      # æ¸¸æˆåç§°
    # game_id: "10001"          # æ¸¸æˆID
    # room_num: "1"             # æˆ¿é—´å·
    # game_room: "room-00001"   # æ¸¸æˆæˆ¿é—´æ ‡è¯†

    # å¯é€‰é…ç½®å˜é‡
    gameserver_start_supervisor: false    # æ˜¯å¦è‡ªåŠ¨å¯åŠ¨æœåŠ¡
    gameserver_backup_enabled: true       # æ˜¯å¦å¯ç”¨å¤‡ä»½
    gameserver_backup_count: 5           # ä¿ç•™å¤‡ä»½æ•°é‡

    # è·¯å¾„é…ç½®ï¼ˆå¦‚æœé»˜è®¤å€¼ä¸åˆé€‚ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¦†ç›–ï¼‰
    gameserver_project_root_dir: /usr/local/game-server
    gameserver_supervisor_user: root

    # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
    gameserver_deploy_start_time: "{{ ansible_date_time.iso8601 }}"

  pre_tasks:
    - name: æ˜¾ç¤ºéƒ¨ç½²å‚æ•°
      ansible.builtin.debug:
        msg: |
          ==================== éƒ¨ç½²å‚æ•° ====================
          æ¸¸æˆåç§°: {{ game_name | default('æœªè®¾ç½®') }}
          æ¸¸æˆID: {{ game_id | default('æœªè®¾ç½®') }}
          æˆ¿é—´å·: {{ room_num | default('æœªè®¾ç½®') }}
          æ¸¸æˆæˆ¿é—´: {{ game_room | default('æœªè®¾ç½®') }}
          ç›®æ ‡ä¸»æœº: {{ inventory_hostname }}
          è‡ªåŠ¨å¯åŠ¨: {{ gameserver_start_supervisor }}
          å¯ç”¨å¤‡ä»½: {{ gameserver_backup_enabled }}
          ================================================

  roles:
    - role: gameserver
      tags: 
        - gameserver
        - deploy

  post_tasks:
    - name: æ˜¾ç¤ºéƒ¨ç½²å®Œæˆä¿¡æ¯
      ansible.builtin.debug:
        msg: |
          ==================== éƒ¨ç½²å®Œæˆ ====================
          ğŸ‰ æ¸¸æˆæœåŠ¡å™¨éƒ¨ç½²æˆåŠŸï¼

          å¿«é€Ÿå‘½ä»¤:
          æŸ¥çœ‹çŠ¶æ€: sudo supervisorctl status {{ gameserver_supervisor_program_name | default('gameserver') }}
          æŸ¥çœ‹æ—¥å¿—: sudo tail -f {{ gameserver_host_log_dir | default('/usr/local/game-server/log') }}/
                   {{ gameserver_supervisor_program_name | default('gameserver') }}-access.log
          
          è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ä¸Šé¢çš„ä»»åŠ¡è¾“å‡ºã€‚
          ================================================
